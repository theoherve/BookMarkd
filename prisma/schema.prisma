// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("BOOK_MARKD_POSTGRES_URL_NON_POOLING")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique
  username     String?  @unique
  displayName  String   @map("display_name")
  passwordHash String   @map("password_hash")
  avatarUrl    String?  @map("avatar_url")
  bio          String?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  booksCreated           Book[]             @relation("BookCreator")
  userBooks              UserBook[]
  topBooks               UserTopBook[]
  reviews                Review[]
  reviewLikes            ReviewLike[]
  reviewComments         ReviewComment[]
  listsOwned             List[]             @relation("ListOwner")
  listCollaborators      ListCollaborator[]
  followsAsFollower      Follow[]           @relation("Follower")
  followsAsFollowing     Follow[]           @relation("Following")
  followRequestsSent     FollowRequest[]    @relation("FollowRequestRequester")
  followRequestsReceived FollowRequest[]    @relation("FollowRequestTarget")
  activities             Activity[]
  recommendations        Recommendation[]

  @@map("users")
}

model Book {
  id              String   @id @default(uuid()) @db.Uuid
  openLibraryId   String?  @unique @map("open_library_id")
  title           String
  author          String
  coverUrl        String?  @map("cover_url")
  publicationYear Int?     @map("publication_year")
  summary         String?
  averageRating   Decimal? @default(0) @map("average_rating") @db.Decimal(3, 2)
  ratingsCount    Int      @default(0) @map("ratings_count")
  createdBy       String?  @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  creator         User?            @relation("BookCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  bookTags        BookTag[]
  userBooks       UserBook[]
  topBooks        UserTopBook[]
  reviews         Review[]
  listItems       ListItem[]
  recommendations Recommendation[]

  @@map("books")
}

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  bookTags BookTag[]

  @@map("tags")
}

model BookTag {
  bookId    String   @map("book_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([bookId, tagId])
  @@map("book_tags")
}

model UserBook {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  bookId      String    @map("book_id") @db.Uuid
  status      String // 'to_read' | 'reading' | 'finished'
  rating      Decimal?  @db.Decimal(2, 1)
  ratedAt     DateTime? @map("rated_at") @db.Timestamptz(6)
  notePrivate String?   @map("note_private")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@map("user_books")
}

model UserTopBook {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  bookId    String   @map("book_id") @db.Uuid
  position  Int // 1, 2, or 3
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([userId, position])
  @@unique([userId, bookId])
  @@map("user_top_books")
}

model Review {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  bookId     String   @map("book_id") @db.Uuid
  visibility String // 'public' | 'friends' | 'private'
  title      String?
  content    String
  spoiler    Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  book     Book            @relation(fields: [bookId], references: [id], onDelete: Cascade)
  likes    ReviewLike[]
  comments ReviewComment[]

  @@map("reviews")
}

model ReviewLike {
  reviewId  String   @map("review_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([reviewId, userId])
  @@map("review_likes")
}

model ReviewComment {
  id        String   @id @default(uuid()) @db.Uuid
  reviewId  String   @map("review_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  content   String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("review_comments")
}

model List {
  id              String   @id @default(uuid()) @db.Uuid
  ownerId         String   @map("owner_id") @db.Uuid
  title           String
  description     String?
  visibility      String // 'public' | 'unlisted' | 'private'
  isCollaborative Boolean  @default(false) @map("is_collaborative")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  owner         User               @relation("ListOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  items         ListItem[]
  collaborators ListCollaborator[]

  @@map("lists")
}

model ListItem {
  id        String   @id @default(uuid()) @db.Uuid
  listId    String   @map("list_id") @db.Uuid
  bookId    String   @map("book_id") @db.Uuid
  position  Int
  note      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  list List @relation(fields: [listId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([listId, bookId])
  @@map("list_items")
}

model ListCollaborator {
  listId    String   @map("list_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String // 'editor' | 'viewer'
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  list List @relation(fields: [listId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([listId, userId])
  @@map("list_collaborators")
}

model Follow {
  followerId  String   @map("follower_id") @db.Uuid
  followingId String   @map("following_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@map("follows")
}

model FollowRequest {
  id          String    @id @default(uuid()) @db.Uuid
  requesterId String    @map("requester_id") @db.Uuid
  targetId    String    @map("target_id") @db.Uuid
  status      String // 'pending' | 'accepted' | 'rejected'
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  respondedAt DateTime? @map("responded_at") @db.Timestamptz(6)

  // Relations
  requester User @relation("FollowRequestRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  target    User @relation("FollowRequestTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([requesterId, targetId])
  @@map("follow_requests")
}

model Activity {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String // 'rating' | 'review' | 'status_change' | 'list_update' | 'follow'
  payload   Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activities")
}

model Recommendation {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  bookId    String   @map("book_id") @db.Uuid
  source    String // 'friends' | 'global' | 'similar'
  score     Decimal  @db.Decimal(5, 2)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@map("recommendations")
}
